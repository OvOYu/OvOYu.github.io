<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LeanCloud Debug</title>
  <style>
    body { font-family: Arial; padding: 30px; background: #f5f5f5; }
    .log { padding: 10px; margin: 5px 0; background: white; border-left: 4px solid #667eea; border-radius: 4px; }
    .error { border-left-color: #f44336; background: #ffebee; }
    .success { border-left-color: #4caf50; background: #e8f5e9; }
    button { padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #5568d3; }
    h1 { color: #333; }
  </style>
</head>
<body>
  <h1>LeanCloud Connection Test</h1>
  <button onclick="testConnection()">Retest Connection</button>
  <div id="logs"></div>
  
  <script>
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = 'log ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
      div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
      document.getElementById('logs').appendChild(div);
      console.log(msg);
    }
    
    log('Step 1: Loading LeanCloud SDK...');
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js" onload="onSDKLoaded()" onerror="onSDKError()"></script>
  
  <script>
    function onSDKLoaded() {
      log('STEP 2 SUCCESS: LeanCloud SDK loaded', 'success');
      testConnection();
    }
    
    function onSDKError() {
      log('STEP 2 FAILED: SDK loading failed - network issue', 'error');
    }
    
    async function testConnection() {
      try {
        log('Step 3: Initializing LeanCloud...');
        
        const appId = 'zEBpxeuvNAB1AzNQ7ECkykgg-MdYXbMMI';
        const appKey = 'vkh9k9NXJOLNrbgOqrdMqlQ1';
        const serverURL = 'https://zebpxeuv.api.lncldglobal.com';
        
        log('AppID prefix: ' + appId.substring(0, 8));
        log('ServerURL: ' + serverURL);
        
        AV.init({
          appId: appId,
          appKey: appKey,
          serverURL: serverURL
        });
        
        log('STEP 4 SUCCESS: Initialization complete', 'success');
        
        log('Step 5: Querying Counter table...');
        
        let counter = null;
        try {
          const query = new AV.Query('Counter');
          query.equalTo('name', 'blessing-likes');
          counter = await query.first();
        } catch (queryError) {
          if (queryError.code === 101) {
            log('Step 6: Counter table does not exist (error 101)');
          } else {
            throw queryError;
          }
        }
        
        if (counter) {
          log('STEP 6 SUCCESS: Counter found, value: ' + counter.get('count'), 'success');
          log('ALL TESTS PASSED! Like feature is ready!', 'success');
        } else {
          log('Step 7: Creating Counter table...');
          
          const Counter = AV.Object.extend('Counter');
          const newCounter = new Counter();
          newCounter.set('name', 'blessing-likes');
          newCounter.set('count', 0);
          
          const acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          newCounter.setACL(acl);
          
          log('Step 8: Saving to cloud...');
          await newCounter.save();
          
          log('STEP 9 SUCCESS: Counter created!', 'success');
          log('ALL TESTS PASSED! Like feature is ready!', 'success');
        }
        
      } catch (error) {
        log('ERROR: ' + error.message, 'error');
        log('Error code: ' + (error.code || 'unknown'), 'error');
        
        if (error.message.includes('network') || error.message.includes('timeout') || error.code === 1) {
          log('SUGGESTION: Network issue detected:', 'error');
          log('1. LeanCloud International is hosted outside China', 'error');
          log('2. May be blocked by firewall', 'error');
          log('3. Consider using LeanCloud China version', 'error');
        }
      }
    }
  </script>
</body>
</html>

